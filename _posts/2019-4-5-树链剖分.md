---
layout: post
title: 2019-4-5 树链剖分

date: 2019-4-5 
categories: blog
tags: [,]
description: 
---

---------------------

```c++
void dfs1(int u,int fa){
	siz[u] = 1;
	for (int i = head[u];i;i = E[i].nxt)	if (E[i].y != fa){
		dep[E[i].y] = dep[u] + 1;
		f[E[i].y] = u;
		dfs1(E[i].y,u);
		siz[u] += siz[E[i].y];
	}
	for (int i = head[u];i;i = E[i].nxt)	if (E[i].y != fa){
		if (siz[E[i].y] > siz[son[u]])	son[u] = E[i].y;
	}
}
void dfs2(int u,int fa,int tp){
	top[u] = tp;
	idx[++ct] = u;
	dfn[u] = ct;
	if (son[u])	dfs2(son[u],u,tp);
	for (int i = head[u];i;i = E[i].nxt)	if (E[i].y != fa && E[i].y != son[u])	dfs2(E[i].y,u,E[i].y);
}
struct node{
	int l,r,sum,add;
}T[MAXN << 2];
void build(int o,int l,int r){
	T[o].l = l;T[o].r = r;T[o].add = 0;
	if (l == r){
		T[o].sum = val[idx[l]];
		return;
	}
	build(o << 1,l,(l + r) >> 1);
	build(o << 1 | 1,((l + r) >> 1) + 1,r);
	T[o].sum = ((ll)T[o << 1].sum + T[o << 1 | 1].sum) % p;
}
inline void add_node(int o,int num){
	(T[o].add += num) %= p;
	(T[o].sum += (ll)num * (T[o].r - T[o].l + 1) % p) %= p;
}
inline void pushdown(int o){
	if (T[o].add){
		add_node(o << 1,T[o].add);
		add_node(o << 1 | 1,T[o].add);
		T[o].add = 0;
	}
}
void modify(int o,int l,int r,int num){
	if (l <= T[o].l && T[o].r <= r){
		add_node(o,num);
		return;
	}
	if (l > T[o].r || T[o].l > r)	return;
	pushdown(o);
	modify(o << 1,l,r,num);
	modify(o << 1 | 1,l,r,num);
	T[o].sum = (T[o << 1].sum + T[o << 1 | 1].sum) % p;
}
int query(int o,int l,int r){
	if (l <= T[o].l && T[o].r <= r)	return T[o].sum;
	if (l > T[o].r || T[o].l > r)	return 0;
	pushdown(o);
	return (query(o << 1,l,r) + query(o << 1 | 1,l,r)) % p;
}
inline void modify_path(int u,int v,int num){
	while(top[u] != top[v]){
		if (dep[top[u]] < dep[top[v]])	swap(u,v);
		modify(1,dfn[top[u]],dfn[u],num);
		u = f[top[u]];
	}
	if (dep[u] < dep[v])	swap(u,v);
	modify(1,min(dfn[u],dfn[v]),max(dfn[u],dfn[v]),num);
}
inline int query_path(int u,int v){
	int res = 0;
	while(top[u] != top[v]){
		if (dep[top[u]] < dep[top[v]])	swap(u,v);
		(res += query(1,dfn[top[u]],dfn[u])) %= p;
		u = f[top[u]];
	}
	if (dep[u] < dep[v])	swap(u,v);
	(res += query(1,min(dfn[u],dfn[v]),max(dfn[u],dfn[v]))) %= p;
	return res;
}
```